<!DOCTYPE html>

<meta charset="utf-8" />

<title>Win32Forth</title>

<script language="javascript" type="text/javascript">
var lastlen=0;
var fHeader='';
var startstop=0;
var sendint=false;
var r1st=0;
var hline=0;
var dsp;

function doit(cntnu)
{
  if(sendint){
     sendint=false;
     cntnu=4;
  }
  if(fHeader==5){
     fHeader=0;
     return;
  }
  if(startstop==3){
     cntnu=3;
  }
  var ntxt=cntnu.toString();
  if(!cntnu){
    var txt=dsp.value;
    ntxt=txt.substring(lastlen-1);
    if(ntxt=='dir\n'){
       ntxt='webdir';
    }
    else if(ntxt=='cls\n'){
      dsp.value='ok\n';
      lastlen=4;
      return;
    }
    if(!fHeader &&  ntxt[ntxt.length-1] == '\n'){
      ntxt=ntxt.slice(0,ntxt.length-1);}
    if(ntxt[0]=='\n') ntxt=ntxt.slice(1);
  }
  fetch('',{method: 'post',body:ntxt,headers: {
      'Content-Type': 'text/plain'
     }
  })
  .then(response =>{
    fHeader = response.headers.get('ForthContinue');
    if(!fHeader){
       hline = response.headers.get('Linenum');
    }
    return response.text();
   })
  .then(function(data) {
     if(hline){
        handleview(data,hline);
        hline=0;
        var dtxt=dsp.value;
        lastlen=dtxt.length;
        return;
     }
     var dtxt=dsp.value;
     if((!fHeader || r1st) && dtxt[dtxt.length-1]=='\n'){
      dtxt=dtxt.slice(0,dtxt.length-1);
     }
     r1st=0;
     if(fHeader==5) fHeader=0;
     if(data[0]!=' ')data=' '+data;
     dtxt+=data;
     lastlen=dtxt.length;
     dsp.value=dtxt;
     dsp.scrollTop=dsp.scrollHeight;
     if(fHeader==2 && !window.startstop){
        doit(1);
     }
  })
  .catch(error => console.log('error is', error));
}

function handleview(data,hline){
   var elftxt=document.getElementById('filetxt');
   elftxt.value=data;
   var rows=elftxt.value.split('\n').length;
   var lineHeight = parseInt(elftxt.scrollHeight/rows);
   dptr=Math.max(hline-3,0) * lineHeight;
   elftxt.scrollTop=dptr;
}

</script>
      <script type = "text/javascript">
         function WebSocketTest() {            
            ws = new WebSocket("ws://24.5.42.64:8000/wstest");
            if ("WebSocket" in window) {
               ws.onopen = function() {                  
                  // Web Socket is connected, send data using send()
                  ws.send("open ok");
               };
				
               ws.onmessage = function (evt) {
                  var txt=evt.data;
                  document.getElementById('aa').textContent=txt;
               };
				
               //ws.onclose = function() {                   
               //   alert("Connection is closed..."); 
               //};
            } else {              
               alert("WebSocket NOT supported by your Browser!");
            }
         }
         function sendtxt(){
            txt=document.getElementById('bb').value;
            ws.send(txt);
         }
         window.addEventListener("load", WebSocketTest, false);

function getfile(){
  var fname=document.getElementById('filename').value;
  if(!fname){
    alert('need to enter a file name');
    return;
  }
  fetch('',{method: 'post',body:'',headers: {
      'Content-Type': 'text/plain',
      'FileGet': fname
     }
  })
  .then(response =>{
    return response.text();
   })
  .then(function(data) {
     var filetxt=document.getElementById('filetxt');
     filetxt.value=data;
     })
  .catch(error => console.log('failed to get file: ', error));
}

function putfile(){
  var fname=document.getElementById('filename').value;
  var filetxt=document.getElementById('filetxt').value;
  fetch('',{method: 'post',body:filetxt,headers: {
      'Content-Type': 'text/plain',
      'FilePut': fname
     }
  })
  .then(response =>{
    return response.text();
   })
  .catch(error => console.log('failed to put file: ', error));
}

function webload(){
  dsp.value+='webload '
  dsp.value+=document.getElementById('filename').value;
  r1st=1;
  doit(0);
}


</script>
<body>
<br>
Web32Forth 5.00 by Robert Ackerman & John Peters 415-239-5393<br>
This is also an application or database of electrical parts. Contract Generator TM<cg>
<div>
 <br>
 file name: <input type='text' id='filename' value=''></input> <button onclick="getfile();">get file</button>
 &nbsp;<button onclick="webload();">load file</button>&nbsp;<button onclick="putfile();">save file</button>
 <br>
 <textarea id='filetxt' rows=18 cols=88 style="font-family:courier;font-size:14px;font-weight:bold;"></textarea>
 <br>
 The Console is below; The editor is above
 <br>
 <textarea id='dsp' rows=12 cols=88 autofocus style="font-family:courier;font-size:18px;font-weight: bold;background-color:RoyalBlue;color:#fff"></textarea>
</div><br>
<br>
---- Bottom of console.<br>
<br>
Win32Forth and all it's thousands of words are here for you to use. Be brave & fear not.<br>
Type 'words' to see all the definitions in the system.<br>
The space-bar will START-STOP and the ESC key will break-out from a listing of WORDS in the console.<br>

<script>
    dsp=document.getElementById('dsp');
    	dsp.value='ok\n';
    lastlen=4;
    document.addEventListener("keyup",function(event) {
      if(event.target != dsp) return;
      if (event.key === "Enter") {
        r1st=1;
        doit(0);
      }
      else if(event.key === 'Escape' && fHeader){  // quit long response
        sendint=true;
        }
        else if(fHeader){    // start/stop long response
          if(startstop){
            startstop=0;
            event.preventDefault();
            doit(2);       // continue
          }
          else{
            startstop=3;
            event.preventDefault();
          }
        }
    });
</script>
The system is case INsensitive. For a reset, text me. sf ca 415-239-5393 John Alan Peters<br>
If you get a -13 error with a good Forth word then watch out for your system's spell-check or smart-punctuation.<br>
<br>

RUNNING with FORTH on the WEB and STUDENT lesson ONE<br>
Enter some Forth code in the TOP window, or copy-paste the "Hello world" code.<br>
&#58 TEST cr 8 0 do &#46&#34 Hi World &#34 cr loop &#59<br>
In the box where it says "FILE NAME:" Enter your choice of a file name<br>
SAVE the file, LOAD the file, TEST the file.<br>
Type the name of your word in the console to make sure it works,<br>
Popup test one - Add the words 'That's all folks' in the right place in the code without the ' tick marks.<br>
Popup test two - Change the number of do-loops from 8 to anoter number, LOAD it, RUN it by loading it and TEST it.<br>
If you GET an error, try again. To REVERT to the last saved code GET the file again.<br>
If you get an ok then type<br>
Test<br>
You did it!<br>
Enter your email addess and I will be glad to know you were here :-) - Ignore the error message.<br>
The book Sarting Forth and the lessons will work. It is best to use the updated free online version.<br>
Here is the URL http://home.iae.nl/users/mhx/sf.html<br>
<br>
We could use some help with some code for reverting text strokes and automatic backup files.<br>
Unfortunatly VIEW does not work here. It requies VIEW running on the hard disk system from GitHub. A.Q. for how.<br>
To make VIEW work here via a browser is a time consuming task. Suggestions?  VIEW works, but it depends on the HD.<br>
<br>
You might try some of the Contract Generator words. Rember to use the enter key to stop WORDS.<br>
ELECTRIC WORDS<br>
ELECTRIC VOCS<br>
BULBS WORDS will give you prices and times.<br>
FISH-IN-WALLS PR<br>
SW<br>
LT<br>
</body>
</html>

