<!DOCTYPE html>

<meta charset="utf-8" />

<title>Win32Forth</title>

<script language="javascript" type="text/javascript">
var lastlen=0;
var fHeader='';
var startstop=0;
var sendint=false;
var r1st=0;
var hline=0;
var dsp;

function doit(cntnu)
{
  if(sendint){
     sendint=false;
     cntnu=4;
  }
  if(fHeader==5){
     fHeader=0;
     return;
  }
  if(startstop==3){
     cntnu=3;
  }
  var ntxt=cntnu.toString();
  if(!cntnu){
    var txt=dsp.value;
    ntxt=txt.substring(lastlen-1);
    if(ntxt=='dir\n'){
       ntxt='webdir';
    }
    else if(ntxt=='cls\n'){
      dsp.value='ok\n';
      lastlen=4;
      return;
    }
    if(!fHeader &&  ntxt[ntxt.length-1] == '\n'){
      ntxt=ntxt.slice(0,ntxt.length-1);}
    if(ntxt[0]=='\n') ntxt=ntxt.slice(1);
  }
  fetch('',{method: 'post',body:ntxt,headers: {
      'Content-Type': 'text/plain'
     }
  })
  .then(response =>{
    fHeader = response.headers.get('ForthContinue');
    if(!fHeader){
       hline = response.headers.get('Linenum');
    }
    return response.text();
   })
  .then(function(data) {
     if(hline){
        handleview(data,hline);
        hline=0;
        var dtxt=dsp.value;
        lastlen=dtxt.length;
        return;
     }
     var dtxt=dsp.value;
     if((!fHeader || r1st) && dtxt[dtxt.length-1]=='\n'){
      dtxt=dtxt.slice(0,dtxt.length-1);
     }
     r1st=0;
     if(fHeader==5) fHeader=0;
     if(data[0]!=' ')data=' '+data;
     dtxt+=data;
     lastlen=dtxt.length;
     dsp.value=dtxt;
     dsp.scrollTop=dsp.scrollHeight;
     if(fHeader==2 && !window.startstop){
        doit(1);
     }
  })
  .catch(error => console.log('error is', error));
}

function handleview(data,hline){
   var elftxt=document.getElementById('filetxt');
   elftxt.value=data;
   var rows=elftxt.value.split('\n').length;
   var lineHeight = parseInt(elftxt.scrollHeight/rows);
   dptr=Math.max(hline-3,0) * lineHeight;
   elftxt.scrollTop=dptr;
}

</script>
      <script type = "text/javascript">
         function WebSocketTest() {            
            ws = new WebSocket("ws://24.5.42.64:8000/wstest");
            if ("WebSocket" in window) {
               ws.onopen = function() {                  
                  // Web Socket is connected, send data using send()
                  ws.send("open ok");
               };
				
               ws.onmessage = function (evt) {
                  var txt=evt.data;
                  document.getElementById('aa').textContent=txt;
               };
				
               //ws.onclose = function() {                   
               //   alert("Connection is closed..."); 
               //};
            } else {              
               alert("WebSocket NOT supported by your Browser!");
            }
         }
         function sendtxt(){
            txt=document.getElementById('bb').value;
            ws.send(txt);
         }
         window.addEventListener("load", WebSocketTest, false);

function getfile(){
  var fname=document.getElementById('filename').value;
  if(!fname){
    alert('need to enter a file name');
    return;
  }
  fetch('',{method: 'post',body:'',headers: {
      'Content-Type': 'text/plain',
      'FileGet': fname
     }
  })
  .then(response =>{
    return response.text();
   })
  .then(function(data) {
     var filetxt=document.getElementById('filetxt');
     filetxt.value=data;
     })
  .catch(error => console.log('failed to get file: ', error));
}

function putfile(){
  var fname=document.getElementById('filename').value;
  var filetxt=document.getElementById('filetxt').value;
  fetch('',{method: 'post',body:filetxt,headers: {
      'Content-Type': 'text/plain',
      'FilePut': fname
     }
  })
  .then(response =>{
    return response.text();
   })
  .catch(error => console.log('failed to put file: ', error));
}

function webload(){
  dsp.value+='webload '
  dsp.value+=document.getElementById('filename').value;
  r1st=1;
  doit(0);
}


</script>
<body>
Web32Forth 5.02 by Robert Ackerman & John Peters 415-239-5393.<br>
The word "BYE" is now ok you use. It will send you an invation.<br>
<a href="https://github.com/JohnAlanPeters/cg">github repository</a>
<div>

 file name: <input type='text' id='filename' value=''></input> <button onclick="getfile();">get file</button>
 &nbsp;<button onclick="putfile();">save file</button>&nbsp;<button onclick="webload();">load file</button>
 The file has to end in dot-F .F for it to load. Sample: JohnPetersTest.f NOTE!! VIEW now works,<br>


 <textarea id='filetxt' rows=18 cols=120 style="font-family:courier;font-size:14px;font-weight:bold;"></textarea>
<br>
 The Console is below; The Editor is above. Please be the 1st to text me at 415-239-5393 Why do you hesitate?
<br>
 <textarea id='dsp' rows=24 cols=88 autofocus style="font-family:courier;font-size:18px;font-weight: bold;background-color:RoyalBlue;color:#fff"></textarea>
</div>
<pre><b>
Win32Forth and all it's thousands of words are here for you to use. Be brave & fear not..
The system is case INsensitive. For a reset, text me. sf ca 415-239-5393 John Alan Peters.
If you get a -13 error with a known good Forth word check your system's spell-check or smart-punctuation..

VIEW now works. It shows the whole file in the editor. Try it on a big file (I have not yet)

You can use VIEW to view VIEW are rlataivly small file.  Type VIEW VIEW.

If you type 'WORDS' you will see the hendred of words in the default ELECTRIC directory..
Type 'FORTH WORDS to see all the FORTH definitions in the system.  Instructions below

The space-bar will START-STOP and the ESC key will break-out from a listing of WORDS in the console.
</b></pre>
<script>
    dsp=document.getElementById('dsp');
    	dsp.value='ok\n';
    lastlen=4;
    document.addEventListener("keyup",function(event) {
      if(event.target != dsp) return;
      if (event.key === "Enter") {
        r1st=1;
        doit(0);
      }
      else if(event.key === 'Escape' && fHeader){  // quit long response
        sendint=true;
        }
        else if(fHeader){    // start/stop long response
          if(startstop){
            startstop=0;
            event.preventDefault();
            doit(2);       // continue
          }
          else{
            startstop=3;
            event.preventDefault();
          }
        }
    });
</script>

<pre><b>
&#58 TEST cr 8 0 do &#46&#34 Hi World &#34 cr loop &#59

RUNNING with FORTH on the Webby.

Type in some Forth code or copy-paste some of your code in to the top window.
Give it a [file name] like YourName.f (It is the only way we will know you were here.)
SAVE the file.
LOAD the file to add your words to the dictionaary.
Type the name of your word in the console to make sure it works.

If you enter the name of the definition as the last line in the file, then it will execut with the LOAD command.

Pop-up test - Change the number of do-loops from 8 to anoter number, LOAD it, RUN it and TEST it.

If you GET an error, and you have saved your file, you can [get file] it again and try again.

You did it!.

The book Sarting Forth has lessons. Use the updated free online version..
Here is the URL
http://home.iae.nl/users/mhx/sf.html.
( I don't know why it is not "live")

We could use some help with ideas for improvments.

VIEW works fine. You may like the source code for te following words.
view start-stop
view do-server
view patch
view view  (Yes you can view view )

You might try some of the Contract Generator words. Rember to use the enter key to stop WORDS..
ELECTRIC WORDS
ELECTRIC VOCS
BULBS WORDS will give you prices and times..
FISH-IN-WALLS PR
</b></pre>
SW
LT
</body>
</html>

