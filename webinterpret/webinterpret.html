<!DOCTYPE html>

<meta charset="utf-8" />

<title>Win32Forth</title>

<script language="javascript" type="text/javascript">
var lastlen=0;
var fHeader='';
var startstop=0;
var sendint=false;
var r1st=0;
var hline=0;
var dsp;

function doit(cntnu)
{
  if(sendint){
     sendint=false;
     cntnu=4;
  }
  if(fHeader==5){
     fHeader=0;
     return;
  }
  if(startstop==3){
     cntnu=3;
  }
  var ntxt=cntnu.toString();
  if(!cntnu){
    var txt=dsp.value;
    ntxt=txt.substring(lastlen-1);
    if(ntxt=='dir\n'){
       ntxt='webdir';
    }
    else if(ntxt=='cls\n'){
      dsp.value='ok\n';
      lastlen=4;
      return;
    }
    if(!fHeader &&  ntxt[ntxt.length-1] == '\n'){
      ntxt=ntxt.slice(0,ntxt.length-1);}
    if(ntxt[0]=='\n') ntxt=ntxt.slice(1);
  }
  fetch('',{method: 'post',body:ntxt,headers: {
      'Content-Type': 'text/plain'
     }
  })
  .then(response =>{
    fHeader = response.headers.get('ForthContinue');
    if(!fHeader){
       hline = response.headers.get('Linenum');
    }
    return response.text();
   })
  .then(function(data) {
     if(hline){
        handleview(data,hline);
        hline=0;
        var dtxt=dsp.value;
        lastlen=dtxt.length;
        return;
     }
     var dtxt=dsp.value;
     if((!fHeader || r1st) && dtxt[dtxt.length-1]=='\n'){
      dtxt=dtxt.slice(0,dtxt.length-1);
     }
     r1st=0;
     if(fHeader==5) fHeader=0;
     if(data[0]!=' ')data=' '+data;
     if(data.includes('cls')){
       data=data.replace('cls','');
       dsp.value='';
       dtxt='';
       lastlen=0;
     }
     dtxt+=data;
     lastlen=dtxt.length;
     dsp.value=dtxt;
     dsp.scrollTop=dsp.scrollHeight;
     if(fHeader==2 && !window.startstop){
        doit(1);
     }
  })
  .catch(error => console.log('error is', error));
}

function handleview(data,hline){
   elftxt.value=data;
   var rows=elftxt.value.split('\n').length;
   var lineHeight = parseInt(elftxt.scrollHeight/rows);
   dptr=Math.max(hline-3,0) * lineHeight;
   elftxt.scrollTop=dptr;
}

</script>
      <script type = "text/javascript">
         function WebSocketTest() {            
            ws = new WebSocket("ws://24.5.42.64:8000/wstest");
            if ("WebSocket" in window) {
               ws.onopen = function() {                  
                  // Web Socket is connected, send data using send()
                  ws.send("open ok");
               };
				
               ws.onmessage = function (evt) {
                  var txt=evt.data;
                  document.getElementById('aa').textContent=txt;
               };
				
               //ws.onclose = function() {                   
               //   alert("Connection is closed..."); 
               //};
            } else {              
               alert("WebSocket NOT supported by your Browser!");
            }
         }
         function sendtxt(){
            txt=document.getElementById('bb').value;
            ws.send(txt);
         }
         window.addEventListener("load", WebSocketTest, false);

function getfile(){
  var fname=document.getElementById('filename').value;
  if(!fname){
    alert('need to enter a file name');
    return;
  }
  fetch('',{method: 'post',body:'',headers: {
      'Content-Type': 'text/plain',
      'FileGet': fname
     }
  })
  .then(response =>{
    return response.text();
   })
  .then(function(data) {
     var filetxt=document.getElementById('filetxt');
     filetxt.value=data;
     })
  .catch(error => console.log('failed to get file: ', error));
}

function putfile(){
  var fname=document.getElementById('filename').value;
  var filetxt=document.getElementById('filetxt').value;
  fetch('',{method: 'post',body:filetxt,headers: {
      'Content-Type': 'text/plain',
      'FilePut': fname
     }
  })
  .then(response =>{
    return response.text();
   })
  .catch(error => console.log('failed to put file: ', error));
}

function webload(){
  dsp.value+='webload '
  dsp.value+=document.getElementById('filename').value;
  r1st=1;
  doit(0);
}


</script>
<body>
Web32Forth 5.02 by Robert Ackerman & John Peters 415-239-5393.<br>
A Webby timer restarts on the hour.<br>
Get the source here.
<a href="https://github.com/JohnAlanPeters/cg">github repository</a>
<div>

 file name: <input type='text' id='filename' value=''></input> <button onclick="getfile();">get file</button>
 &nbsp;<button onclick="putfile();">save file</button>&nbsp;<button onclick="webload();">load file</button>
<br>The file has to end in dot-F .F for it to load. Sample: JohnPetersTest.f NOTE!! VIEW now works,<br>


 <textarea id='filetxt' rows=18 cols=120 style="font-family:courier;font-size:14px;font-weight:bold;"></textarea>
<br>
 The Console is below; The Editor is above.
<br>
 <textarea id='dsp' rows=24 cols=88 autofocus style="font-family:courier;font-size:18px;font-weight: bold;background-color:RoyalBlue;color:#fff"></textarea>
</div>

<pre><b>
Win32Forth and all it's thousands of words (Like a library) ready to use. Use VIEW to look around..
The system is case INsensitive.
If you get a -13 error turn off your spell-checker.

VIEW works. It lists the file in the editor. Try it on DO-SERVER or START-STOP
Yes you can VIEW the source of VIEW it's self.  Type VIEW VIEW.

If you type 'WORDS' you will get ELECTRIC WORDS in the default ELECTRIC directory..
Instead use 'FORTH WORDS to see all the FORTH definitions in the system.
The space-bar will START-STOP and the ESC key will break-out from a listing of WORDS in the console.
</b></pre>
<script>
    elftxt=document.getElementById('filetxt');
    dsp=document.getElementById('dsp');
    	dsp.value='ok\n';
    lastlen=4;
    document.addEventListener("keydown",function(event) {
      if(event.target==elftxt && (event.keyCode==9 || event.which==9)){
        event.preventDefault();
        var s=elftxt.selectionStart;
        var ev=elftxt.value;
        elftxt.value=ev.substring(0,s)+Array(16).fill('\xa0').join('')+ev.substring(s);
        elftxt.selectionEnd=s+16;
      }
      if(event.target != dsp) return;
      if (event.key === "Enter") {
        r1st=1;
        doit(0);
      }
      else if(event.key === 'Escape' && fHeader){  // quit long response
        sendint=true;
        }
        else if(fHeader){    // start/stop long response
          if(startstop){
            startstop=0;
            event.preventDefault();
            doit(2);       // continue
          }
          else{
            startstop=3;
            event.preventDefault();
          }
        }
    });
</script>

<pre><b>
RUNNING with FORTH on the Webby.
Copy/paste this in to the editor.
: TEST cr 8 0 do ." Hi World" cr loop ;
Or copy-paste some of your own code in to the top editor.
Give it a [file name] like YourName.f (Nice to meet you, good to know you are here.)
SAVE the file (So you can GET it back if you do an oops.)
LOAD the file (It will compile your words into the dictionaary.)
Enter your word in the console to see it work.
If you include your word in the file, it will execute when you next LOAD your file.
For fun change the number of do-loops from 8 to another number, LOAD it, RUN it.
If you GET an error, and you have saved your file, you can [get file] it again and try again.
Starting Forth has lessons. Use the updated free online version.. Here is the URL
</b></pre>
<a href="http://home.iae.nl/users/mhx/sf.html">starting forth</a>
<pre><b>
We could use some help with ideas for improvments.

VIEW works fine. You may like the source code for te following words.
view START-STOP
view DO-SERVER
view PATCH
view VIEW  (Yes you can view view )

Try some Contract Generator words.
ELECTRIC WORDS
ELECTRIC VOCS
BULBS WORDS will give you prices and times..
FISH-IN-WALLS PR
</b></pre>
SW
LT
</body>
</html>

